From 50437c46e26ae04657dd06c194a226e60b58256f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Julian=20R=C3=BCth?= <julian.rueth@fsfe.org>
Date: Thu, 28 Dec 2023 01:37:49 -0600
Subject: [PATCH 2/3] Load TIMEVAL struct for Windows

---
 source/libnormaliz/binomial.cpp         | 30 +++++++++++++++++++++++++
 source/libnormaliz/binomial.h           |  1 -
 source/libnormaliz/general.cpp          | 19 ++++++----------
 source/libnormaliz/general.h            |  9 ++++++++
 source/libnormaliz/project_and_lift.cpp |  9 ++++++++
 5 files changed, 55 insertions(+), 13 deletions(-)

diff --git a/source/libnormaliz/binomial.cpp b/source/libnormaliz/binomial.cpp
index b9805e2..ad2d7d1 100644
--- a/source/libnormaliz/binomial.cpp
+++ b/source/libnormaliz/binomial.cpp
@@ -23,6 +23,36 @@
 
 #include "libnormaliz/binomial.h"
 
+#ifdef _WIN32
+// Do not let Windows headers define min/max macros that confused GMP.
+#define NOMINMAX
+#include <stdint.h> // portable: uint64_t   MSVC: __int64
+#include <winsock.h>
+
+static int gettimeofday(struct timeval * tp, struct timezone * tzp)
+{
+    // Note: some broken versions only have 8 trailing zero's, the correct epoch has 9 trailing zero's
+    // This magic number is the number of 100 nanosecond intervals since January 1, 1601 (UTC)
+    // until 00:00:00 January 1, 1970
+    static const uint64_t EPOCH = ((uint64_t) 116444736000000000ULL);
+
+    SYSTEMTIME  system_time;
+    FILETIME    file_time;
+    uint64_t    time;
+
+    GetSystemTime( &system_time );
+    SystemTimeToFileTime( &system_time, &file_time );
+    time =  ((uint64_t)file_time.dwLowDateTime )      ;
+    time += ((uint64_t)file_time.dwHighDateTime) << 32;
+
+    tp->tv_sec  = (long) ((time - EPOCH) / 10000000L);
+    tp->tv_usec = (long) (system_time.wMilliseconds * 1000);
+    return 0;
+}
+#else
+#include <sys/time.h>
+#endif
+
 using std::cout;
 using std::endl;
 using std::string;
diff --git a/source/libnormaliz/binomial.h b/source/libnormaliz/binomial.h
index 64d651e..299faf1 100644
--- a/source/libnormaliz/binomial.h
+++ b/source/libnormaliz/binomial.h
@@ -24,7 +24,6 @@
 #ifndef LATTICE_BINOMIAL_H
 #define LATTICE_BINOMIAL_H
 
-#include <sys/time.h>
 #include <string>
 #include "libnormaliz/matrix.h"
 
diff --git a/source/libnormaliz/general.cpp b/source/libnormaliz/general.cpp
index 6f578be..2e1c048 100644
--- a/source/libnormaliz/general.cpp
+++ b/source/libnormaliz/general.cpp
@@ -25,20 +25,13 @@
 #include <csignal>
 #include "libnormaliz/general.h"
 
-#ifndef _MSC_VER
-#include <sys/time.h>
-#else
-#define WIN32_LEAN_AND_MEAN
-#include <Windows.h>
+#ifdef _WIN32
+// Do not let Windows headers define min/max macros that confused GMP.
+#define NOMINMAX
 #include <stdint.h> // portable: uint64_t   MSVC: __int64
+#include <winsock.h>
 
-// MSVC defines this in winsock2.h!?
-typedef struct timeval {
-    long tv_sec;
-    long tv_usec;
-} timeval;
-
-int gettimeofday(struct timeval * tp, struct timezone * tzp)
+static int gettimeofday(struct timeval * tp, struct timezone * tzp)
 {
     // Note: some broken versions only have 8 trailing zero's, the correct epoch has 9 trailing zero's
     // This magic number is the number of 100 nanosecond intervals since January 1, 1601 (UTC)
@@ -58,6 +51,8 @@ int gettimeofday(struct timeval * tp, struct timezone * tzp)
     tp->tv_usec = (long) (system_time.wMilliseconds * 1000);
     return 0;
 }
+#else
+#include <sys/time.h>
 #endif
 
 namespace libnormaliz {
diff --git a/source/libnormaliz/general.h b/source/libnormaliz/general.h
index b87624f..622dc06 100644
--- a/source/libnormaliz/general.h
+++ b/source/libnormaliz/general.h
@@ -31,6 +31,15 @@
 #include <string>
 #include <vector>
 
+#ifdef _WIN32
+// Do not let Windows headers define min/max macros that confused GMP.
+#define NOMINMAX
+#include <stdint.h> // portable: uint64_t   MSVC: __int64
+#include <winsock.h>
+#else
+#include <sys/time.h>
+#endif
+
 #include <libnormaliz/dynamic_bitset.h>
 
 #ifndef NMZ_MAKEFILE_CLASSIC
diff --git a/source/libnormaliz/project_and_lift.cpp b/source/libnormaliz/project_and_lift.cpp
index 108e321..579708a 100644
--- a/source/libnormaliz/project_and_lift.cpp
+++ b/source/libnormaliz/project_and_lift.cpp
@@ -26,6 +26,15 @@
 #include "libnormaliz/sublattice_representation.h"
 #include "libnormaliz/cone.h"
 
+#ifdef _WIN32
+// Do not let Windows headers define min/max macros that confused GMP.
+#define NOMINMAX
+#include <stdint.h> // portable: uint64_t   MSVC: __int64
+#include <winsock.h>
+#else
+#include <sys/time.h>
+#endif
+
 namespace libnormaliz {
 using std::vector;
 using std::string;
-- 
2.43.0

